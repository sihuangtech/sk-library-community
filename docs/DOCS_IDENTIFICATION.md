# 彩旗藏书APP软件设计文档

---

## 一、软件名称与版本

- 软件名称：彩旗藏书
- 版本号：V1.0
- 开发环境：Node.js 18+、Nuxt.js 3、SQLite、Prisma ORM
- 文档编写日期：2025年6月

---

## 二、用途与适用范围

彩旗藏书APP是一款面向家庭和小型组织的图书管理系统，旨在帮助用户高效管理家庭藏书、追踪借阅情况、统计图书数据。适用于家庭、个人书房、小型图书角等场景。

- 典型场景：
  - 家庭成员录入家中所有藏书，定期借阅给亲友，系统自动追踪归还情况。
  - 小型读书会管理员用系统管理流通书籍，统计借阅活跃度，定期备份数据。

---

## 三、组成结构与主要模块

### 1. 系统结构

- 前端：基于Vue 3 + Nuxt 3，提供响应式Web界面，适配PC与移动端。
- 后端：基于Nuxt 3的Nitro Server，负责API服务、认证、数据库操作。
- 数据库：SQLite本地数据库，Prisma ORM管理，数据安全可控。
- 配置：config.yaml集中管理系统参数，支持灵活调整。
- 辅助脚本：一键启动、更新、回滚脚本，简化运维。

### 2. 主要目录结构

```
├── components/      # 前端组件（如图书列表、搜索框、消息弹窗等）
├── layouts/         # 页面布局（如主布局、登录页布局）
├── pages/           # 路由页面（如首页、图书管理、借阅管理、设置等）
├── server/api/      # 后端API接口（RESTful风格，分模块管理）
├── prisma/          # 数据库配置与迁移（schema.prisma、migrations）
├── middleware/      # 中间件（如认证、全局拦截）
├── plugins/         # 插件（如认证插件）
├── docs/            # 项目文档
├── config.yaml      # 系统配置
├── scripts/         # 辅助脚本（如数据库初始化、配置更新）
```

### 3. 移动端APP（ArkUI-X）
- 移动端APP基于 ArkUI-X 框架开发，主力支持 HarmonyOS NEXT，同时兼容 Android/iOS。
- 采用高内聚、低耦合的模块化架构，服务层（如 BookService、AuthService、HttpService、StorageService）单例管理，页面与服务分离。
- 主要开发语言为 ArkTS，开发环境为 DevEco Studio。
- 主要目录结构：
```
CaiQiLibrary/entry/src/main/ets/
├── common/         # 公共常量、类型
├── services/       # 业务服务（如图书、认证、存储、网络）
├── pages/          # 页面（如登录、主页、图书列表、添加图书、借阅、设置等）
│   ├── home/       # 首页、图书列表、图书详情
│   ├── addbook/    # 添加图书
│   ├── borrow/     # 借阅管理
│   ├── settings/   # 系统设置、用户信息、数据库状态等
│   └── ...         # 其它页面
└── ...
```
- 主要页面：
  - `LoginPage.ets`：登录与服务器配置
  - `HomePage.ets`、`BookListPage.ets`、`BookDetailPage.ets`：首页、图书列表、详情
  - `AddBookPage.ets`：添加图书（含ISBN扫码、拍照）
  - `BorrowPage.ets`：借阅管理
  - `SettingsPage.ets`、`UserInfoCard.ets`、`SystemInfoCard.ets`：设置与信息
- 主要服务：
  - `BookService.ets`：图书数据管理、ISBN查询、借阅状态
  - `AuthService.ets`：认证、登录状态、服务器地址
  - `HttpService.ets`：统一API请求、认证头、错误处理
  - `StorageService.ets`：本地数据持久化、偏好设置、缓存

---

## 四、功能规格说明（结合实际实现细节）

### 1. 用户认证模块
- 管理员登录、登出、会话管理，所有管理操作需登录。
- 认证接口：/api/auth/login、/api/auth/logout、/api/auth/verify。
- 支持会话有效期配置，防止长期未操作自动退出。
- 密码遗忘可通过编辑config.yaml重置。

### 2. 图书管理模块
- **图书信息字段**：ISBN（唯一）、标题、作者、出版社、出版日期、价格、页数、装帧、分类、描述、封面图片URL、借阅状态、借阅人、借阅时间、应还日期、创建/更新时间。
- **添加图书流程**：
  1. 进入"添加图书"页面，可选择"ISBN自动获取"或"手动录入"。
  2. ISBN自动获取时，系统调用第三方API（如ISBN Market），自动填充书名、作者、封面等信息，用户可补充或修正。
  3. 手动录入时，需填写ISBN、标题、作者等必填项，支持上传封面图片。
  4. 提交后，系统校验ISBN唯一性，成功则入库并在图书列表中展示。
- **图书列表**：支持分页、关键词搜索（标题/作者/ISBN）、分类筛选、借阅状态筛选。每本书可点击查看详情、编辑、删除。
- **图书详情页**：展示所有字段及借阅历史，支持编辑、删除操作。
- **删除操作**：需二次确认，删除后不可恢复。

### 3. 智能搜索与筛选模块
- 支持按标题、作者、ISBN等关键词搜索。
- 分类筛选、借阅状态筛选，可组合多条件。
- 搜索与筛选结果实时展示，提升查找效率。

### 4. 借阅管理模块
- **借出流程**：
  1. 在图书详情页点击"借出"，弹出借阅信息填写框。
  2. 填写借阅人姓名、手机号、预计归还日期，确认后，图书状态变为"已借出"，借阅信息记录入库。
- **归还流程**：
  1. 在"借阅管理"页面或图书详情页，找到已借出图书，点击"归还"。
  2. 系统自动记录归还时间，状态恢复为"可借阅"。
- **逾期提醒**：系统自动标红逾期未还图书，便于管理员及时跟进。
- **借阅历史**：每本书的借阅记录可追溯，便于统计和管理。

### 5. 数据统计与首页概览模块
- 首页展示：图书总数、已借出数量、可借阅数量、分类统计、热门图书排行等。
- 统计页面：可按分类、借阅频率等多维度统计，辅助用户了解藏书结构和借阅活跃度。

### 6. 系统设置与数据库管理模块
- **数据库初始化**：首次部署或需重置时，点击"一键初始化数据库"，系统自动创建表结构，清空旧数据。
- **数据库备份**：点击"备份数据库"，系统自动生成带时间戳的备份文件，保存在`backups/`目录。
- **系统信息**：展示当前版本、Node.js环境、运行时长、内存占用等。
- **主要配置项在线/离线管理**：如网站名称、API密钥、认证设置等。

### 7. API接口模块
- RESTful风格，接口分模块管理，详见API文档。
- 典型接口：
  - `/api/books`：图书增删改查
  - `/api/books/:id/borrow`：借出图书
  - `/api/books/:id/return`：归还图书
  - `/api/categories`：分类管理
  - `/api/system/backup-database`：数据库备份
- 所有管理API均需认证，输入参数严格校验，防止SQL注入和XSS。

### 8. 移动端APP核心功能（ArkUI-X实现，CaiQiLibrary）
- **双登录模式**：支持彩旗藏书官方服务和自部署服务，登录方式可切换，支持服务器地址配置。
- **图书管理**：增删改查、ISBN自动查询、扫码录入、拍照上传封面。
- **借阅管理**：借出、归还、借阅状态管理，快速操作。
- **本地存储与同步**：StorageService负责本地缓存，支持离线部分操作，联网后自动同步。
- **系统设置**：账户信息、界面设置、数据库状态、系统信息等。
- **移动端专属体验**：扫码、拍照、手势滑动、下拉刷新、深色模式、字体自适应等。
- **API兼容**：与Web端共享后端接口，数据实时同步。

---

## 五、主要界面与操作流程（结合实际页面与流程）

### 1. 登录界面
- 输入管理员用户名和密码，登录系统。
- 忘记密码可通过编辑config.yaml重置。
- 登录后自动跳转首页。

### 2. 首页
- 显示系统概览、统计信息、快捷入口。
- 快速入口：添加图书、查看图书馆、借阅管理、系统设置。

### 3. 图书管理
- **图书列表**：分页展示所有图书，支持搜索、筛选。
- **图书详情**：展示详细信息、借阅历史。
- **编辑/删除**：支持信息修改与安全删除。

### 4. 添加图书
- 支持ISBN自动填充与手动录入。
- 校验ISBN唯一性，防止重复。
- 可上传封面图片，完善图书信息。

### 5. 借阅管理
- **借出**：填写借阅人信息，确认借出。
- **归还**：一键归还，状态实时更新。
- **逾期提醒**：逾期图书高亮显示，便于管理。

### 6. 系统设置
- **数据库管理**：初始化、备份、状态查看。
- **系统信息**：版本、运行环境、内存等。
- **配置管理**：网站信息、API密钥、认证设置。

### 移动端APP主要界面与流程（CaiQiLibrary实际实现）
- **登录页面（LoginPage.ets）**：支持官方/自部署登录，服务器地址配置，表单验证。
- **主页（HomePage.ets）**：图书统计、功能入口、用户信息。
- **图书列表页（BookListPage.ets）**：图书展示、搜索、筛选、快速借阅/归还。
- **图书详情页（BookDetailPage.ets）**：展示完整信息，支持借阅、归还。
- **添加图书页（AddBookPage.ets）**：信息录入、ISBN自动查询、扫码、拍照、表单校验。
- **借阅管理页（BorrowPage.ets）**：借阅记录、状态管理。
- **设置页（SettingsPage.ets）**：账户、界面、数据库、系统信息等。
- 所有页面均有详细中文注释，界面适配移动端，交互流畅。

---

## 六、配置与部署说明（结合实际命令与配置项）

### 1. 环境要求
- Node.js 18.0+
- NPM 8.0+
- Git

### 2. 快速启动
- Windows：`start.bat`
- Mac/Linux：`chmod +x start.sh && ./start.sh`

### 3. 手动部署
```bash
npm install
cp config.yaml.example config.yaml
npx prisma migrate dev --name init
npm run dev
```
- 访问 http://localhost:3008

### 4. 主要配置项（config.yaml）
- `server.port`：服务端口
- `site.name`：网站名称
- `api.isbn_key`：ISBN查询API密钥
- `database.url`：数据库文件路径
- `admin.username`/`admin.password`：管理员账号
- `auth.session_max_age_days`：会话有效期
- 详见 config.yaml.example

### 5. 一键更新与回滚
- `update.bat`/`update.sh`：一键拉取最新代码、自动备份、依赖同步、数据库迁移
- `rollback.bat`/`rollback.sh`：一键恢复数据库、配置、代码到上一个安全状态
- 备份文件保存在`backups/`目录，命名含时间戳，便于追溯

### 移动端APP构建与部署（CaiQiLibrary）
- 开发环境：DevEco Studio，ArkTS语言。
- 支持 HarmonyOS NEXT、Android、iOS，打包后可通过各平台应用市场或扫码安装。
- 首次启动需配置服务器地址，登录后与Web端数据实时同步。
- 详细构建、打包、安装流程见 CaiQiLibrary/BUILD.md。

---

## 七、测试与运行说明（结合实际测试流程）

### 1. 功能测试
- 登录/登出测试：验证认证流程，确保未登录无法访问管理功能
- 图书管理测试：添加、编辑、删除、搜索、筛选，校验数据准确性
- 借阅管理测试：借出、归还、逾期提醒，验证借阅流程完整性
- 数据统计测试：首页与统计页面数据准确性
- 系统设置测试：数据库初始化、备份、信息展示，确保操作安全可靠

### 2. 兼容性测试
- 桌面端主流浏览器（Chrome、Edge、Firefox）
- 移动端浏览器自适应，界面友好

### 3. 数据安全测试
- 数据备份与恢复流程验证，确保数据可追溯、可恢复
- 管理员密码修改与会话有效性测试，防止未授权访问

### 4. 运行维护
- 定期备份数据库，建议每周至少一次
- 使用 update.bat / update.sh 一键更新，保持系统最新
- 使用 rollback.bat / rollback.sh 回滚，防止误操作导致数据丢失
- 日志监控、健康检查，及时发现并解决问题

### 5. 常见问题与解决方案
- 忘记管理员密码：编辑config.yaml重置密码，重启应用
- ISBN查不到图书信息：检查ISBN号、网络连接、API密钥
- 系统卡顿：检查数据库大小、清理旧备份、重启应用
- 数据丢失：使用最近备份文件恢复

### 移动端APP测试与兼容性
- 适配主流HarmonyOS NEXT、Android、iOS手机和平板，支持不同分辨率和屏幕尺寸。
- 重点测试：
  - 登录与服务器切换
  - ISBN扫码、拍照上传
  - 图书增删改查、借阅归还
  - 离线缓存与数据同步
  - 设置、账户、数据库状态
  - 深色模式、字体自适应、手势交互
- 所有功能均有详细测试用例，保障数据一致性与用户体验。

---

## 八、开发原则与工程结构说明

- 高内聚、低耦合：各模块功能独立，接口清晰，便于维护和扩展
- 模块化设计：前后端、API、数据库、脚本等分层分目录管理
- 代码文件建议不超200行，复杂功能合理拆分
- 每个类、函数、模块、脚本均有详细中文注释，说明用途、参数、返回值、调用场景
- 命名规范统一，前端camelCase，后端snake_case，数据库小写下划线
- 自动化脚本覆盖构建、部署、格式化、测试等任务，提升开发效率
- 目录结构清晰，/src、/features、/services、/utils、/constants、/types等分工明确
- 入口与导出文件统一用index.*管理
- 支持后续功能扩展与二次开发，便于团队协作