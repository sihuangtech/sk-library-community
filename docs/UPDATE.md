# 更新文档

本文档详细介绍家庭图书管理系统的更新和回滚功能。

## 一键更新功能

项目提供了自动更新脚本，可以从Gitee仓库拉取最新代码并自动更新系统。

### 使用方法

#### Windows系统
```bash
update.bat
```

#### Mac/Linux系统
```bash
chmod +x update.sh  # 只需要第一次运行时执行
./update.sh
```

### 更新功能特点

- 🔍 **智能检测**：自动检查是否有新版本可用
- 💾 **自动备份**：更新前自动备份数据库和配置文件
- 🔄 **安全更新**：暂存本地更改，更新后自动恢复
- 📦 **依赖同步**：自动更新项目依赖包
- 🗄️ **数据库迁移**：自动应用数据库结构更新
- ⚡ **零停机**：更新过程中保护用户数据

### 更新流程详解

#### 1. 环境检查阶段
- 检查Git是否安装
- 检查Node.js和npm是否可用
- 验证当前目录是否为Git仓库

#### 2. 备份阶段
- 创建 `backups/` 目录（如不存在）
- 备份当前数据库文件到 `backups/library_backup_YYYYMMDD_HHMMSS.db`
- 备份配置文件到 `backups/config_backup_YYYYMMDD.yaml`

#### 3. 代码更新阶段
- 暂存本地未提交的更改（`git stash`）
- 从远程仓库获取最新信息（`git fetch`）
- 检查是否有新的提交
- 如无更新则恢复本地更改并退出
- 拉取最新代码（`git pull origin main`）

#### 4. 环境同步阶段
- 更新npm依赖包（`npm install`）
- 重新生成Prisma客户端（`npx prisma generate`）
- 应用数据库迁移（`npx prisma migrate deploy`）
- 如迁移失败则尝试推送schema（`npx prisma db push`）

#### 5. 恢复设置阶段
- 恢复之前暂存的本地更改（`git stash pop`）
- 显示更新摘要和提示信息

### 更新输出示例

```
========================================
   家庭图书管理系统 - 一键更新脚本
========================================

🔍 检查当前Git仓库状态...

📋 更新前准备工作...
💾 备份数据库文件...
✅ 数据库已备份到: backups/library_backup_20241215_143022.db
💾 备份配置文件...
✅ 配置文件已备份

🔄 开始从Gitee仓库拉取最新代码...
📦 暂存本地更改...
🌐 获取远程更新信息...
📊 发现 3 个新提交，开始更新...
📥 拉取最新代码...
✅ 代码更新成功

📦 更新项目依赖...
✅ 依赖更新完成

🗄️  更新数据库结构...
✅ 数据库更新完成

🔄 恢复本地更改...

========================================
✅ 更新完成！
========================================

📋 更新摘要：
  - 已拉取 3 个新提交
  - 依赖包已更新
  - 数据库结构已同步
  - 本地更改已恢复

💡 提示：
  - 数据库备份位置: backups/
  - 如有问题可回滚到备份版本
  - 建议重启应用以确保更新生效

🚀 现在可以运行 start.bat 启动应用
```

## 回滚功能

如果更新后出现问题，可以使用回滚脚本快速恢复到之前的状态。

### 使用方法

#### Windows系统
```bash
rollback.bat
```

#### Mac/Linux系统
```bash
chmod +x rollback.sh  # 只需要第一次运行时执行
./rollback.sh
```

### 回滚选项

回滚脚本提供了多种回滚选项：

#### 1. 回滚数据库到最新备份
- 恢复到更新前的数据库状态
- 自动选择最新的数据库备份文件
- 在回滚前会备份当前数据库

#### 2. 回滚配置文件到最新备份
- 恢复到更新前的配置文件状态
- 自动选择最新的配置文件备份
- 在回滚前会备份当前配置文件

#### 3. 回滚代码到上一个提交
- 撤销最近的Git提交
- 自动重新安装依赖
- **注意**：此操作会永久删除最新的提交

#### 4. 完全回滚（数据库+配置+代码）
- 一键恢复所有更改
- 按顺序回滚数据库、配置文件和代码
- 最安全的回滚方式

#### 5. 查看Git提交历史
- 显示最近10次提交记录
- 帮助了解代码变更历史

### 回滚界面示例

```
========================================
   家庭图书管理系统 - 回滚脚本
========================================

🔍 查找可用的备份文件...

📊 可用的数据库备份：
library_backup_20241215_143022.db
library_backup_20241214_092015.db

⚙️  可用的配置文件备份：
config_backup_20241215.yaml
config_backup_20241214.yaml

========================================
请选择回滚操作：
========================================
1. 回滚数据库到最新备份
2. 回滚配置文件到最新备份
3. 回滚代码到上一个提交
4. 完全回滚（数据库+配置+代码）
5. 查看Git提交历史
0. 退出
========================================
请输入选择 (0-5):
```

## 备份文件管理

### 备份文件命名规则

#### 数据库备份
- 格式：`library_backup_YYYYMMDD_HHMMSS.db`
- 示例：`library_backup_20241215_143022.db`
- 位置：`backups/` 目录

#### 配置文件备份
- 格式：`config_backup_YYYYMMDD.yaml`
- 示例：`config_backup_20241215.yaml`
- 位置：`backups/` 目录

### 备份文件清理

建议定期清理旧的备份文件以节省磁盘空间：

```bash
# 删除30天前的备份文件（Linux/Mac）
find backups/ -name "library_backup_*.db" -mtime +30 -delete
find backups/ -name "config_backup_*.yaml" -mtime +30 -delete

# Windows PowerShell
Get-ChildItem backups/ -Name "library_backup_*.db" | Where-Object {$_.LastWriteTime -lt (Get-Date).AddDays(-30)} | Remove-Item
```

## 更新前注意事项

### 1. 数据备份
- 更新脚本会自动备份，但建议手动额外备份重要数据
- 确保备份文件存储在安全位置

### 2. 配置检查
- 检查当前配置是否正确
- 记录自定义的配置项

### 3. 环境准备
- 确保网络连接正常
- 确保有足够的磁盘空间
- 关闭正在运行的应用实例

### 4. 权限检查
- 确保有文件读写权限
- 确保有Git操作权限

## 更新失败处理

### 常见更新失败原因

#### 1. 网络连接问题
```bash
❌ 获取远程更新失败，请检查网络连接
```
**解决方案**：
- 检查网络连接
- 检查Git仓库地址是否正确
- 尝试手动执行 `git fetch origin`

#### 2. 本地文件冲突
```bash
❌ 代码拉取失败
```
**解决方案**：
- 检查是否有未提交的重要更改
- 手动解决冲突后重新运行更新脚本
- 或使用回滚脚本恢复到更新前状态

#### 3. 依赖安装失败
```bash
❌ 依赖安装失败
```
**解决方案**：
- 检查npm配置
- 清除npm缓存：`npm cache clean --force`
- 删除node_modules后重新安装

#### 4. 数据库迁移失败
```bash
⚠️  数据库迁移可能失败，尝试推送schema...
```
**解决方案**：
- 通常脚本会自动尝试备用方案
- 如仍失败，可手动执行：`npx prisma db push`
- 或使用Web界面的"一键初始化数据库"功能

### 手动恢复步骤

如果自动更新完全失败，可以按以下步骤手动恢复：

#### 1. 恢复代码
```bash
git reset --hard HEAD~1  # 回到上一个提交
```

#### 2. 恢复数据库
```bash
cp backups/library_backup_YYYYMMDD_HHMMSS.db library.db
```

#### 3. 恢复配置
```bash
cp backups/config_backup_YYYYMMDD.yaml config.yaml
```

#### 4. 重新安装依赖
```bash
npm install
```

## 最佳实践

### 1. 更新频率
- 建议每周检查一次更新
- 重要安全更新应立即应用
- 在非业务高峰期进行更新

### 2. 测试环境
- 有条件的话先在测试环境验证更新
- 确认功能正常后再更新生产环境

### 3. 备份策略
- 除了自动备份，定期手动备份到外部存储
- 保留多个版本的备份文件
- 定期测试备份文件的完整性

### 4. 监控更新
- 更新后检查应用是否正常运行
- 监控错误日志
- 验证关键功能是否正常

### 5. 文档记录
- 记录每次更新的内容和时间
- 记录遇到的问题和解决方案
- 建立更新操作手册

## 脚本权限问题

### Windows系统
```bash
# 如果提示权限不足
# 右键点击update.bat，选择"以管理员身份运行"

# 如果提示脚本被阻止
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

### Linux/Mac系统
```bash
# 如果提示权限不足
chmod +x update.sh rollback.sh

# 如果提示找不到命令
# 确保脚本在正确的目录中运行
ls -la update.sh
```

### Git配置问题

#### 配置Git用户信息
```bash
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"
```

#### 重新设置远程仓库
```bash
git remote -v  # 查看当前远程仓库
git remote set-url origin <your-gitee-repo-url>
```

---

如果遇到其他问题，请参考 [部署文档](DEPLOYMENT.md) 中的详细故障排除部分。 